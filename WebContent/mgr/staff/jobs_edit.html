<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
	<meta name="description" content="UFMS云货代系统，实现业务财务一体化，整合企业网站，微信和内部ERP系统。可量身定制开发。对外平台：涵盖客户网上运价查询，在线订舱、补料、对单，查询库存账单及流程跟踪。内部操作系统：包含海运、空运、拖车、报关、仓储、人事行政，内部OA，财务">
	<meta name="author" content="Neo">
	<meta name="keywords" content="UFMS,货代软件,货代系统,财务系统">
	
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	
	
	<link rel="shortcut icon" href="favicon.ico" />
	<link rel="icon" type="image/gif" href="favicon.ico" />
	<title>SO.UFMS </title>
	
	<link rel="stylesheet" href="/so/res/layui/css/layui.css">
	<script src="/so/res/layui/layui.js"></script>
	
	<link rel="stylesheet" href="../../res/static/css/index.css?t=26">
	<link rel="stylesheet" href="../../res/layui/layui-formSelects/formSelects-v4.css">
	
	<script src="/so/res/static/js/jquery.min.js"></script>
	<script src="/so/res/static/js/jquery.cookie.js?t=1"></script>
	<script src="../../admin/js/ufms.common.js?t=13" ></script>
	<script src="/so/admin/js/jquery.i18n.properties-min-1.0.9.js"></script>
	<style type="text/css">
		/*设置下拉框的高度和表格单元相同*/
			.layui-table-box td .layui-form-select{
				margin-top : -5px;
				margin-left : -15px;
				margin-right : -15px;
			}
		/**结束*/
	</style>
</head>
<body>
  <!-- nav部分 
  <div class="nav" id="nav">
  </div>-->
  <!-- main -->
  <div class="layui-container">
		<div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
		  <ul class="layui-tab-title">
		  	<li class="layui-this" style="padding: 0 0px">委托</li>
		    <li style="padding: 0 0px">柜子</li>
		    <li style="padding: 0 0px">费用</li>
		    <li style="padding: 0 0px">流程</li>
		  </ul>
		  <div class="layui-tab-content" style="height: 100px;">
		  	<div class="layui-tab-item layui-show">
		    	<form class="layui-form" lay-filter="jobshipping">
		    		<div class="layui-btn-group">
					  <button type="button" lay-filter="saveshipping" lay-submit
					  		class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal">保存</button>
					</div>
					<div class="layui-form-item layui-hide">
						<input type="text" name="shipid" id="shipid" autocomplete="off" class="layui-input">
					</div>
			    	<div class="layui-form-item">
		    			<div class="layui-inline">
					      <label class="layui-form-label">发货人</label>
					      <div class="layui-input-inline">
					        <textarea type="text" name="cnortitle" autocomplete="off" class="layui-textarea"></textarea>
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">收货人</label>
					      <div class="layui-input-inline">
					        <textarea type="text" name="cneetitle" autocomplete="off" class="layui-textarea"></textarea>
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">通知人</label>
					      <div class="layui-input-inline">
					        <textarea type="text" name="notifytitle" autocomplete="off" class="layui-textarea"></textarea>
					      </div>
					    </div>
					    <div class="layui-inline">
							<label class="layui-form-label">目的港代理</label>
							<div class="layui-input-inline">
								<select name="agentdesid" bind="comboboxs">
						        	<option value="">请选择</option>
						        </select>
							</div>
						</div>
					    <div class="layui-inline">
					      <label class="layui-form-label">ETD</label>
					      <div class="layui-input-inline">
					      	<input type="text" name="etd" id="etd" autocomplete="off" class="layui-input layuidata">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">船公司</label>
					      <div class="layui-input-inline">
					        	<select name="carrierid" bind="comboboxs">
						        	<option value="">请选择</option>
						        </select>
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">装货港</label>
					      <div class="layui-input-inline">
					        <input type="text" name="pol" autocomplete="off" class="layui-input">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">目的港</label>
					      <div class="layui-input-inline">
					        <input type="text" name="pod" autocomplete="off" class="layui-input">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">ETA</label>
					      <div class="layui-input-inline">
					      	<input type="text" name="eta" id="date" autocomplete="off" class="layui-input layuidata">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">卸货港</label>
					      <div class="layui-input-inline">
					        <input type="text" name="pdd" autocomplete="off" class="layui-input">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">目的地</label>
					      <div class="layui-input-inline">
					        <input type="text" name="destination" autocomplete="off" class="layui-input">
					      </div>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">截关日</label>
					      <div class="layui-input-inline">
					      	<input type="text" name="clstime" id="date" autocomplete="off" class="layui-input layuidata">
					      </div>
					    </div>
			    	</div>
			    </form>
			</div>
		    <div class="layui-tab-item"><table id="cntTable" lay-filter="cntdetail"></table></div>
		    <div class="layui-tab-item"><table id="actTable" lay-filter="arapFiter"></table></div>
		    <div class="layui-tab-item">
			    <form class="layui-form" id="jobtodo" lay-filter="jobtodofilter">
		  			<!-- <button type="button" class="layui-btn layui-btn-normal FFStartFlow" lay-submit lay-filter="applyBPMform"><i class="layui-icon layui-icon-release"></i>发起流程</button>
				 	 --><div class="layui-form-item" id="jobtodoitem">
				 		<div class="layui-inline">
							<label class="layui-form-label">指派人</label>
							<div class="layui-input-inline" style="width:260px;">
								<select id="taskuer" name="taskuer" lay-search="" xm-select="checkbox_taskuer" xm-select-search="" xm-select-skin="normal">
						         	<option value=""><span class="translate">选择指派人</span></option>
						      	</select>
						      	<input type="text" name="nos" id="nos" autocomplete="off" class="layui-input layui-hide">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">下一环节</label>
							<div class="layui-input-inline">
								<select id="taskDefineSelect" name="bpmassign" class="form-control" type="text" >
									<option value=""><span class="translate">选择下一环节</span></option>
								</select>
							</div>
						</div>
						<div class="layui-inline">
						      <label class="layui-form-label">备注</label>
						      <div class="layui-input-inline">
						        <textarea type="text" name="bpmremark" autocomplete="off" class="layui-textarea"></textarea>
						      </div>
						</div>
						<div class="layui-inline">
							<button type="button" class="layui-btn layui-btn-radius layui-btn-normal" lay-submit lay-filter="applyBPM"><i class="layui-icon layui-icon-ok"></i>确定</button>
						</div>
					</div>
				</form>
			</div>
		</div> 
  	</div>
  </div>
  <form class="layui-form" id="arapFilter" style="display:none" lay-filter="arapFilter">
  		<div class="layui-form-item">
			<div class="layui-form-item">
				<input type="text" name="id" id="id" autocomplete="off" class="layui-input layui-hide">
				<button type="button" class="layui-btn layui-btn-normal" lay-submit lay-filter="savearap" type="submit">保存</button>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">收付</label>
				<div class="layui-input-inline">
					<select name="araptype">
			        	<option value="AR">应收</option>
			        	<option value="AP">应付</option>
			        </select>
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">PP/CC</label>
				<div class="layui-input-inline">
					<select name="ppcc">
			        	<option value="PP">PP</option>
			        	<option value="CC">CC</option>
			        </select>
				</div>
			</div>
			<div class="layui-form-item">
			    <label class="layui-form-label">客户</label>
			    <div class="layui-input-block">
			       <div id="customeridxm"></div>
			       <!-- <select id="customerid" name="customerid" lay-search="" xm-select="checkbox_custom" xm-select-search="" xm-select-radio="" xm-select-skin="normal">
				        <option value="">选择客户</option>
				   </select> -->
			    </div>
		    </div>
			<div class="layui-inline">
		      <label class="layui-form-label">日期</label>
		      <div class="layui-input-inline">
		      	<input type="text" name="arapdate" id="arapdate" autocomplete="off" class="layui-input layuidata">
		      </div>
		    </div>
		    <div class="layui-inline">
		    	<label class="layui-form-label">费用名称</label>
				<div class="layui-input-inline" style="width:260px;">
					<div id="feeitemidxm"></div>
					<!--<select id="feeitemid" name="feeitemid" lay-search="" xm-select="checkbox_feei" xm-select-search="" xm-select-radio="" xm-select-skin="normal">
				        <option value="">选择费用</option>
				   </select>-->
				</div>
			</div>
			<div class="layui-inline">
		      <label class="layui-form-label">单价</label>
		      <div class="layui-input-inline">
		      	<input type="text" name="price" id="price" autocomplete="off" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">数量</label>
		      <div class="layui-input-inline">
		      	<input type="text" name="piece" id="price" autocomplete="off" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">金额</label>
		      <div class="layui-input-inline">
		      	<input type="text" name="amount" id="amount" autocomplete="off" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">币值</label>
		      <div class="layui-input-inline">
		      	<select name="currency" lay-verify="required" bind="comboboxs">
					     <option value="">请选择</option>
				</select>
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">结算地</label>
		      <div class="layui-input-inline">
		      	<select name="corpid" lay-verify="required">
					     <option value="">请选择</option>
				</select>
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label"></label>
		      <div class="layui-input-inline">
		      	<input type="checkbox" name="isamend" lay-skin="primary" title="增减费用">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">结算方式</label>
		      <div class="layui-input-inline">
		      	<select name="payplace" lay-verify="required">
					     <option value="CS">现金</option>
					     <option value="PB">公账</option>
					     <option value="HK">香港</option>
				</select>
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">描述</label>
		      <div class="layui-input-inline">
		        <textarea type="text" name="descinfo" autocomplete="off" class="layui-textarea"></textarea>
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">备注</label>
		      <div class="layui-input-inline">
		        <textarea type="text" name="remarks" autocomplete="off" class="layui-textarea"></textarea>
		      </div>
		    </div>
		</div>
  </form>
  <!-- footer部分
  <div class="footer" id="footer"> 
  </div>-->
<!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<script type="text/html" id="checkboxTpl">
  <input type="checkbox" name="lock" disabled value="{{d.id}}" lay-skin="primary" title="" lay-filter="lockDemo" {{ d.isgetmbl == true ? 'checked' : '' }}>
</script>
<script type="text/html" id="ishblissigncheckbox">
  <input type="checkbox" name="ishblissign" disabled value="{{d.id}}" lay-skin="primary" title="" lay-filter="ishblissignfil" {{ d.ishblissign == true ? 'checked' : '' }}>
</script>
<script type="text/html" id="toolbar">
  <div class="layui-btn-container">
	<button class="layui-btn layui-btn-sm  layui-btn-normal" type="button" lay-event="querycnt"><i class="layui-icon layui-icon-refresh-3"></i>刷新</button>
	<button class="layui-btn layui-btn-sm  layui-btn-normal" type="button" lay-event="savecnt"><i class="layui-icon layui-icon-file"></i>保存</button>
	<button class="layui-btn layui-btn-sm  layui-btn-normal" type="button" lay-event="addcnt"><i class="layui-icon layui-icon-add-circle"></i>新增</button>
	<button class="layui-btn layui-btn-sm  layui-btn-normal" type="button" lay-event="deletecnt"><i class="layui-icon layui-icon-delete"></i>删除</button>
  </div>
</script>
<script type="text/html" id="arapBar">
  <button class="layui-btn layui-btn-xs fina_arap_update" type="button" lay-event="barEdit"><i class="layui-icon layui-icon-edit"></i>编辑</button>
  <button class="layui-btn layui-btn-xs fina_arap_delete" type="button" lay-event="bardelete"><i class="layui-icon layui-icon-delete"></i>删除</button>
</script>
<script type="text/html" id="araptoolbar">
  <div class="layui-btn-container">
	<button class="layui-btn layui-btn-sm layui-btn-normal fina_arap_add" type="button" lay-event="addarap"><i class="layui-icon layui-icon-add-circle"></i>新增</button>
  </div>
</script>

<script>
layui.use(['jquery','layer','form','table','laydate','formSelects','tablePlug','xmSelect'], function() {
	$ = layui.jquery;
	var form = layui.form,table = layui.table,laydate=layui.laydate
	,formSelects = layui.formSelects, tablePlug = layui.testTablePlug
	xmSelect = layui.xmSelect; //只有执行了这一步，部分表单元素才会自动修饰成功
	form.render();
	getCombobox(form);
	var parav = getRequest();
	var para = new Object;
    para.id = parav.id
    
	actionPost('/jobs','getJobinfo',JSON.stringify(para),function(res){
		var resjson = JSON.parse(res);
    	if(resjson.success == false){
    		layer.msg(resjson.msg,{icon: 7});
		}else{
			form.val("jobshipping",resjson);
			form.val("jobtodofilter",{"nos":resjson.nos});
		}
	});
	table.render({
		elem: '#cntTable'
	        ,height: 500
	        ,limit: Number.MAX_VALUE
	        ,url:getContextPath()+"/jobs?method=cntlist&id="+parav.id+getSid()
	        ,id:'cntTable'
	        ,toolbar: '#toolbar'
	        ,cols: [[
				{type: 'checkbox', fixed: 'left'},
				{field:'id', width:80, title: 'ID',hide:true},
	            {field: 'cntno', title: '箱号', width: 120, edit: 'text'},
	            {field: 'ldtype', title: '箱型', width: 80, templet: '#selectLdtype'},
	            {field: 'cntypeid', title: '箱量', width: 120, edit: 'text'},
	            {field: 'sono', title: '订舱号', width: 100, edit: 'text'},
	            {field: 'goodsname', title: '货物名称', width: 100, edit: 'text'},
	            {field: 'piece', title: '件数', width: 80, edit: 'text'},
	            {field: 'grswgt', title: '毛重', width: 80, edit: 'text'},
	         ]]
            ,done: function (res, curr, count) {
    		    $('th').css({'background-color': '#7aa9d9', 'color': 'white','line-height': '38px'});
    	    }
	});
	table.render({
		elem: '#actTable'
	        ,height: 500
	        ,limit: Number.MAX_VALUE
	        ,url:getContextPath()+"/jobs?method=actlist&id="+parav.id+getSid()
	        ,id:'actTable'
	        ,toolbar: '#araptoolbar'
	        ,cols: [[
	            {field: 'araptype', title: '类别', width: 60},
	            {field: 'arapdate', title: '日期', width: 110},
	            {field: 'customeabbr', title: '客户简称', width: 120},
	            {field: 'feeitemdec', title: '费用项目', width: 150},
	            {field: 'currency', title: '币制', width: 60},
	            {field: 'amount', title: '金额', width: 100,align : 'right'},
	            {field: 'amtstate', title: '状态', width: 60},
	            {field: 'typepr', title: '收付状态', width: 100},
	            {fixed: 'right', title: '操作', width:150, align:'center', toolbar: '#arapBar'}
	         ]]
            ,done: function (res, curr, count) {
				$('th').css({'background-color': '#7aa9d9', 'color': 'white','line-height': '38px'});
    		    var paradata = new Object();paradata.pid = 299000;
    		    setButtonClass(paradata);
    	    }
	});
	lay('.layuidata').each(function() {
		laydate.render({ 
		  elem: this
		  ,theme: '#1e9fff'
		});
	});
	//randerfromselect('/combobox','queryFeei?limit=20','checkbox_feei',formSelects,true);
	//randerfromselect('/combobox','queryCustomer?limit=20&type=arap','checkbox_custom',formSelects,true);
	randerfromselect('/combobox','taskuer?limit=20','checkbox_taskuer',formSelects,true);
	var configDataSet = new randerXmselect.getConfig();configDataSet.model={icon:'hidden'};
	configDataSet.name = 'customerid';configDataSet.action='queryCustomer';configDataSet.el='#customeridxm';
	var customeridxm = new randerXmselect.rander(xmSelect,configDataSet);
	var configDataSetfee = new randerXmselect.getConfig();
	configDataSetfee.name = 'feeitemid';configDataSetfee.action='queryFeei';configDataSetfee.el='#feeitemidxm';
	var feeitemidxm = new randerXmselect.rander(xmSelect,configDataSetfee);
	
	actionGet('/combobox','bpmassign','process_id=6544894888',function(res){
	    var data = JSON.parse(res);
	    for(var i=0; i<data.length; i++){
	    	var option="<option value='"+data[i].val+"'>"+data[i].label+"</option>";
	    	$("select[name=bpmassign]").append(option);
	    }
	    form.render('select','jobtodofilter');
    });
	actionGet('/combobox','corpabbcode','jobid='+parav.id,function(res){
	    var data = JSON.parse(res);
	    for(var i=0; i<data.length; i++){
	    	var option="<option value='"+data[i].val+"'>"+data[i].label+"</option>";
	    	$("select[name=corpid]").append(option);
	    }
	    form.render('select','arapFilter');
    });
	//$('dl[xid="checkbox_feei"]').width('300px');
	form.on('submit(saveshipping)',function(data){
		actionPost('jobs','saveshipping',JSON.stringify(data.field),function(res){
		    	var resjson = JSON.parse(res);
		    	if(resjson.success == false){
		    		layer.msg(resjson.msg,{icon: 7});
				}else{
					layer.msg('OK',{icon: 1});
				}
		});  
	})
	function querycnt(){
		table.reload('cntTable',{url:getContextPath()+"/jobs?method=cntlist&id="+parav.id+getSid()});
	}
	//头工具栏事件
	table.on('toolbar(cntdetail)', function(obj){
		var checkStatus = table.checkStatus(obj.config.id);
	    switch(obj.event){
	      case 'querycnt':
	    	  querycnt();
	      break;
	      case 'savecnt':
	  	    var jsonData = [];
	  	    for(var i=0;i<table.cache.cntTable.length;i++){
	  	    	var obj={}
	  	    	obj.id = table.cache.cntTable[i].id;
	  	    	obj.cntno = table.cache.cntTable[i].cntno;
	  	    	obj.ldtype = table.cache.cntTable[i].ldtype;
	  	    	obj.cntypeid = table.cache.cntTable[i].cntypeid;
	  	    	obj.sono = table.cache.cntTable[i].sono;
	  	    	obj.goodsname = table.cache.cntTable[i].goodsname;
	  	    	obj.piece = table.cache.cntTable[i].piece;
	  	    	obj.grswgt = table.cache.cntTable[i].grswgt;
	  	    	obj.jobid = parav.id;
	  	    	jsonData.push(obj);
		  	}
	  	    //console.log(jsonData);
	  	    actionPost('jobs','savecnt',JSON.stringify(jsonData),function(res){
	  	    	var jsonData = JSON.parse(res);
	  		    if(jsonData.success == true){
	  		    	layer.msg("OK!",{icon: 1});
	  		    }else{
	  		    	layer.msg(jsonData.msg,{icon: 7});
		  		}
	  	    });
		  break;
	      case 'deletecnt':
	    	  var data = checkStatus.data;
		      if(data.length<1){
		      	layer.msg("至少选择一行！",{icon: 5});
		        	return;
			  };
			  actionGet('/esi','deletecnt',"cntids="+getids(data),function(res){
	    		  var jsonData = JSON.parse(res);
	    		  if(jsonData.error){
	    			  if(jsonData.error != ''){
	    			    	layer.alert(jsonData.error, {icon: 7});
	    			  }return;
	    		  }
	              if (checkStatus.data.length < 1) {
	                  layer.alert("请选择一条数据操作");
	                  return false;
	              } else {
	                  var cbList = table.cache.cntTable;
	                  for (var k = 0; k < checkStatus.data.length; k++) {
	                      var _delId = checkStatus.data[k].id;
	                      for (var i = 0; i < cbList.length; i++) {
	                          var _id = cbList[i].id;
	                          if (_id == _delId) {
	                              cbList.splice(i, 1);
	                              break;
	                          }
	                      }
	                  }
	                  table.reload("cntTable", {
	                	  url:"",
	                      data: cbList
	                  })
	              }
	              layer.msg("OK!",{icon: 1});
	    	  });
		  break;
	      case 'addcnt':
		      var datas = []
		      var tabledata = table.cache.cntTable;
		      if(tabledata!=null){
				for(var i=0;i<tabledata.length;i++){
					datas.push(tabledata[i]);
				}
			  }
		      datas.push({
		    	"id": -1   
	    	    ,"cntno": null
	    	    ,"ldtype": ""
	    	    ,"cntypeid": null
	    	    ,"sono": null
	    	    ,"goodsname": ""
	    	    ,"piece": null
	    	    ,"grswgt": null
	    	  });
		      table.reload('cntTable', {
		    	  url:"",
		         data:datas
		      });
		  break;
	    };
	});
	// 监听表格中的下拉选择将数据同步到table.cache中
    form.on('select(selectCntype)', function (data) {
    	refreashgrid(data)
    });
    form.on('select(selecLldtype)', function (data) {
    	refreashgrid(data)
    });
    function refreashgrid(data){
    	 var selectElem = $(data.elem);
         var tdElem = selectElem.closest('td');
         var trElem = tdElem.closest('tr');
         var tableView = trElem.closest('.layui-table-view');
         table.cache[tableView.attr('lay-id')][trElem.data('index')][tdElem.data('field')] = data.value;
    }
	function getids(arrjson){
		var ids ="";
		for(var i=0;i<arrjson.length;i++){
			if(i==0){	
				ids=arrjson[i].id;
	    	}else{
				ids=ids+","+arrjson[i].id;
			}
	    }
	    return ids;
	};
	table.on('tool(arapFiter)', function(obj){
		var data = obj.data;
		var layEvent = obj.event;
		if(layEvent === 'barEdit'){
			var arraval = ['600px', '580px'];
	   		var tille = '编辑';
	  		if(isMove() == true){
	  			arraval = ['100%', '100%'];
	  			tille = '<button type="button" lay-filter="closelayer" onclick="closelayer()" lay-submit class="layui-btn layui-btn-sm supersmall">返回</button>';
	  	  	}
	   		layer.open({
	   		  title:tille,
	   		  type:1,
	   		  move: false,
	   		  fixed: false,
	   		  area: arraval, //宽高
	   		  content: $("#arapFilter")
	   		});
	   		form.val("arapFilter",data);
	   		var customs = [];customs.push(data.customerid);
			var feeis = [];feeis.push(data.feeitemid);
			//formSelects.value('checkbox_custom',customs);
			//formSelects.value('checkbox_feei',feeis);
			customeridxm.setValue(customs);
			feeitemidxm.setValue(feeis);
		}else if(layEvent=='bardelete'){
			actionGet('/jobs','deletearap',"arapids="+data.id,function(res){
		    	var resjson = JSON.parse(res);
		    	if(resjson.success == false){
		    		layer.msg(resjson.msg,{icon: 7});
				}else{
					layer.msg('OK',{icon: 1});
					table.reload('actTable');
				}
			});  
		}
	});
	form.on('submit(savearap)',function(data){
		data.field.jobid =parav.id; console.dir(data.field);
		actionPost('jobs','savearap',JSON.stringify(data.field),function(res){
		    	var resjson = JSON.parse(res);
		    	if(resjson.success == false){
		    		layer.msg(resjson.msg,{icon: 7});
				}else{
					layer.msg('OK',{icon: 1});
					table.reload('actTable');
				}
		});  
	});
	form.on('submit(applyBPMform)',function(data){
		var arraval = ['600px', '580px'];
   		var tille = '发起流程';
  		if(isMove() == true){
  			arraval = ['100%', '100%'];
  			tille = '<button type="button" lay-filter="closelayer" onclick="closelayer()" lay-submit class="layui-btn layui-btn-sm supersmall">返回</button>';
  	  	}
   		layer.open({
   		  title:tille,
   		  type:1,
   		  move: false,
   		  fixed: false,
   		  area: arraval, //宽高
   		  content: $("#jobtodoitem")
   		});
	});
	form.on('submit(applyBPM)',function(data){
		var datajsonstring = JSON.stringify(data.field);
		var taskuer = formSelects.value('checkbox_taskuer', 'valStr');
		var para = new Object;
		para.taskuer = taskuer;
		para.bpmassign = data.field.bpmassign;
		para.bpmremark = data.field.bpmremark;
		para.nos = data.field.nos;
		para.id = parav.id;
		para.processid=6544894888;
		if(para.bpmassign!=null&&para.bpmassign==''){
			alert("#{l.m['下一步环节必填']}!");
			return false;
		}
    	actionPost('/bpm','applyBPM',JSON.stringify(para),function(res){
    		var resjson = JSON.parse(res);
        	if(resjson.success == true){
        		layer.msg("OK",{icon: 1});
        	}else{
				layer.msg(resjson.msg,{icon: 7});
			}
    	})
	});
	
	table.on('toolbar(arapFiter)', function(obj){
		var checkStatus = table.checkStatus(obj.config.id);
		var para = new Object;
		para.jobid = parav.id;
	    switch(obj.event){
	      case 'addarap':
	    	actionPost('/jobs','getAddArap',JSON.stringify(para),function(res){
	      		var resjson = JSON.parse(res);//console.log(resjson);
	          	if(resjson.success == true){
	          		var arraval = ['600px', '580px'];
			   		var tille = '编辑';
			  		if(isMove() == true){
			  			arraval = ['100%', '100%'];
			  			tille = '<button type="button" lay-filter="closelayer" onclick="closelayer()" lay-submit class="layui-btn layui-btn-sm supersmall">返回</button>';
			  	  	}
			   		layer.open({
			   		  title:tille,
			   		  type:1,
			   		  move: false,
			   		  fixed: false,
			   		  area: arraval, //宽高
			   		  content: $("#arapFilter")
			   		});
			   		resjson.arapData.id = -1;
			   		$("#arapFilter")[0].reset();
			   		form.val("arapFilter",resjson.arapData);
			   		var customs = [];customs.push(0);
					var feeis = [];feeis.push(0);
					//formSelects.value('checkbox_custom',customs);
					//formSelects.value('checkbox_feei',feeis);
					customeridxm.setValue(customs);
					feeitemidxm.setValue(feeis);
	          	}else{
	  				layer.msg(resjson.msg,{icon: 7});
	  			}
	      	})
	      break;
	    }
	});
	$('input[name=price]').on('input propertychange', function() {//监听单价改变
		culAmountprice();
	});
	$('input[name=piece]').on('input propertychange', function() {//监听数量改变
		culAmountprice();
	});
	$('input[name=amount]').on('input propertychange', function() {//监听金额改变
		culAmountamont();
	});
	function culAmountprice(){//改变单价或者数量时候触发
		var price = $('input[name=price]').val();//单价
		var piece = $('input[name=piece]').val();//数量
		var amount = $('input[name=amount]').val();//金额
		if(price==null||price==''){
			price = 0 ;
		}
		if(piece==null||piece==''){
			piece = 1 ;
		}//console.log(price);console.log(piece);
		$('input[name=amount]').val(price*piece);//金额 = 单价*数量
	}
	function culAmountamont(){//改变金额时候触发
		var price = $('input[name=price]').val();//单价
		var piece = $('input[name=piece]').val();//数量
		var amount = $('input[name=amount]').val();//金额
		if(amount==null||amount==''){
			price = 0 ;
		}
		if(piece==null||piece==''){
			piece = 1 ;
		}
		$('input[name=price]').val(amount/piece);//金额 = 单价*数量
	}
});

$('.site-demo-active').on('click', function(){
    var othis = $(this), type = othis.data('type');
    active[type] ? active[type].call(this, othis) : '';
  });
</script>
<script type="text/javascript">
    var cntypeArr = [];
    
    actionGet('/combobox','cntype','',function(res){
		var jsonData = JSON.parse(res);
	    cntypeArr = jsonData;
    });
    var ldtypeArr = [{"label":"FCL","val":'F'},{"label":"LCL","val":'L'}];
</script>
<script type="text/html" id="selectLdtype">
	    <select name="cntype" dataId="{{d.id}}" lay-filter="selectCntype" lay-search>
	        {{# layui.each(cntypeArr, function(index, item){}}
	        	<option value={{item.val}} {{ (d.cntypeid==item.val)?'selected' : '' }}>{{ item.label }}</option>
	        {{# }); }}
	    </select>
</script>
<script src="/so/index?method=getCssForButton&pid=299000"></script>
</body>
</html>